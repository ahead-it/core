# Ahead Core
Core is an environment to develop applications based on 
multiple apps, with common rules, sharing business logic and
with simplified code.

Core is based on a multiprocess architecture, one session, user and database connection
for each process.

## Installation
Core requirements:
* [Python](https://www.python.org/downloads/) 3.8 or more
* [pyodbc](https://github.com/mkleehammer/pyodbc) for database access
* [Tornado](https://www.tornadoweb.org/) as web server
* [pyOpenSSL](https://www.pyopenssl.org/) for secure the communication
* [Babel](http://babel.pocoo.org/) for internationalization
* [Pylint](https://www.pylint.org/) for code check
* [Poedit](https://poedit.net/) for translations
* [Watchdog](https://pythonhosted.org/watchdog/) for reload on the fly changed files

Windows requirements:
* [six](https://pypi.org/project/six/) for compatibility
* [pywin32](https://github.com/mhammond/pywin32) for Windows Service (use EXE installer)


## Configuration

### Generate text catalogs
To internationalize your app, you need to generate text
catalogs. Each label is identified in the source code by
the specific keyword `label`.
```
python corecli.py --text app.myapp
```
The command will generate a `translation` directory in the app
base path with the global catalog editable with Poedit.

### Generate symbols
To use Core or develop application you need to generate all
symbols based on currently installed app.
```
python corecli.py --sym
```
You will find the result in the `app` folder with a proxy
module/class for each object type.

### Source code check
You can check source code run linting from
the command line, ex:
```
python corecli.py --check ./app/myapp
```

### Instances
Application is server through one or more instance. An instance
is an environment connected to one physical database responding
to one http(s) port.

Name of the istance is the name of the folder containing
`config.json` in `var/instance` folder.

```json
{
    "display_name": "default",      
    "db_host": "localhost",
    "db_type": "sqlserver",
    "db_login": "sa",
    "db_password": "sa",
    "db_name": "Core"
}
```
Additional properties:
* `db_debug` if True will log each query on instance log file, with parameters, time, caller and session identifier (default: False)
* `dataset_size` is the number of rows fetched from a single SELECT from the database (default: 50)
* `webserver_enabled` enable or disable the webserver (default: False)
* `webserver_port` set the TCP port where webserver will listen (default: 8080)
* `webserver_secure` run webserver in HTTPS mode (default: False)
* `certificate` certificate file name, if not provided one autogenerated is used
* `certificate_key` certificate key file name
* `max_processes` maximum worker processes (default: 32)

Additional properties (Windows only):
* `service_name` Windows service name
* `service_display` Windows service display name

Note: you can create processing only instance without database, simply omitting `db_type` property.

### Folders
This is the folder structure:
* `app` contains the apps available in application, one folder
for each app; contains also the automatic generated symbols
* `core` contains the Core engine
* `var` contains files that can grow during the usage of the application
  * `instance` contains instance definitions, one folder for
  each instance
  * `log` contains application log, one file per day

### Synchronize database schema
To synchronize database schema defined by apps with physical database in check mode:
```
python corecli.py --instance instancename --schema check
```
In this way you will warned about disruptive database changes (columns drop or data change).

If all is OK, you can force the schema synchronization:
```
python corecli.py --instance instancename --schema force
```

## Usage
### Web Server
Core can be used through CLI (via `corecli.py` script) or through
web in REST or websocket mode.

```
python corecli.py --instance instancename --start
```

Following URI are handled:
  * `/` serving file from `var/instance/[instancename]/webroot`
  * `/rpc` for REST API
  * `/ws` for websockets

### Web Server Authentication
It's possible to authenticate through security token:
* Via Cookie with `core-auth-token` key
* Via HTTP headers with `X-Core-AuthToken` key

### REST API
Through REST API only codeunit are served. Prefix `app.codeunit` is added automatically. Arguments can be passed 
via URL with GET method or in HTTP body with POST metod. Arguments must be in JSON format, for example:

```
https://myserver:8080/rpc/MyCodeunit/MyMethod?arg1=100&arg2=test
```
Response is JSON format. In case of exception HTTP status code 500 is returned with exception in JSON
object, for example:
```json
{
  "class": "TypeError", 
  "message": "unsupported operand type(s) for +: 'int' and 'str'", 
  "trace": [
    "in core/webserver.py line 53 'return proxy.invoke(parts[1], **kwargs)'", 
    "in core/utility/proxy.py line 28 'return method(**kwargs)'", 
    "in app/base/codeunit/test.py line 6 'return a + b'"
    ], 
  "type": "exception"
}
```

### Websocket
Websocket protcol is the most powerful way to interact with Core application because it's
a bidirectional way. 

To invoke a method:
```json
{
  "type": "invoke",
  "classname": "app.myapp.codeunit.MathManagement",
  "method": "sum",
  "arguments": {
    "a": 3,
    "b": 4
  }
}
```
The result will be:
```json
{
  "type": "result",
  "value": 7
}
```
In case of error the message is the same than REST API.

A message is sent from server to client (or viceversa) in this way:
```json
{
  "type": "message",
  "value": ...
}
```
To create an object and store it in the current session:
```json
{
  "type": "create",
  "classname": "app.myapp.codeunit.MathManagement"
}
```
Return value is the ID of the object. To invoke a method
on previously created object:
```json
{
  "type": "invoke",
  "objectid": "4d8eb808-7139-4d8e-926a-66f613745771",
  "method": "sum",
  "arguments": {
    "a": 3,
    "b": 4
  }  
}
```
Finally to destroy a created object:
```json
{
  "type": "destroy",
  "objectid": "4d8eb808-7139-4d8e-926a-66f613745771"
}
```

### Run as Windows Service
To install Core as windows service:
```
python corecli.py --install instancename
```
To uninstall:
```
python corecli.py --uninstall instancename
```

## Debug
All events are logged in application or instance log file with
these severities:
  * `E` Error
  * `W` Warning
  * `I` Info
  * `D` Debug

## Language reference
View [Language Reference](reference.md)